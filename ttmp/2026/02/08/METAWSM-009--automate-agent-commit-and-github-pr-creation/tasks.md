# Tasks

## TODO

- [x] Define policy and safety gates for automated commit/PR flow
- [x] Design and add run pull request persistence schema
- [x] Implement service primitives for branch prep and commit creation
- [x] Implement service primitive for GitHub PR creation via gh CLI
- [x] Add metawsm commit command with dry-run previews
- [x] Add metawsm pr command with dry-run previews
- [x] Integrate commit/pr readiness signals into operator loop
- [x] Add tests for commit/preflight rejection paths
- [x] Add tests for PR creation and persisted metadata
- [x] Write operator and agent playbook for commit/PR workflow
- [x] Proposal A V1: add auth preflight check using gh auth status and git credential availability
- [x] Proposal A V1: add metawsm auth check command to report push/PR readiness
- [x] Proposal A V1: record credential mode and actor identity in run events for commit/pr actions
- [x] Validation framework: define extensible check interface and require_all policy semantics
- [x] Validation V1: enforce all configured test commands must pass before commit/pr
- [x] Validation V1: add forbidden-file and clean-tree checks as required gates
- [x] Implement per repo/ticket branch+PR fanout orchestration for multi-repo runs
- [x] Enforce human-only merge policy in operator and CLI surfaces (no auto-merge path)
- [x] Add playbook section for Proposal A setup (gh login, git identity, troubleshooting)
- [x] Add end-to-end test for successful local-auth commit push and PR creation
- [x] Phase 2A.1: add commit preflight capture of current branch/head and base ref/head for diagnostics
- [x] Phase 2A.2: implement dirty-tree snapshot via git stash push -u before checkout-to-base
- [x] Phase 2A.3: implement checkout-to-base plus stash reapply flow with conflict-safe error reporting
- [x] Phase 2A.4: add regression tests for stale-base dirty-tree commit success path
- [x] Phase 2A.5: add regression tests for stash reapply conflict reporting path
- [x] Phase 2B.1: add sqlite3 busy-timeout configuration to all store query/exec invocations
- [x] Phase 2B.2: add bounded retry/backoff for transient sqlite lock/busy failures
- [x] Phase 2B.3: add store tests that hold write locks and verify retry-based eventual success
- [x] Phase 2B.4: add run-level commit/pr mutation lock and typed operation-in-progress error
- [x] Phase 2B.5: add orchestrator tests covering concurrent commit/pr lock rejection behavior
- [x] Phase 2C.1: implement actor resolution chain (flag -> gh auth actor -> git identity)
- [x] Phase 2C.2: persist resolved actor identity in run pull request rows for commit and PR operations
- [x] Phase 2C.3: add tests for actor fallback behavior across flag/gh/git scenarios
- [x] Phase 2C.4: expand commit/pr CLI output with preflight diagnostics and remediation hints
- [x] Phase 2D.1: update operator playbook for native stale-base handling and lock contention behavior
- [x] Phase 2D.2: add e2e test for stale-base workspace commit->push->PR without manual git intervention
- [x] Review feedback V1: add model types for PR review feedback records and lifecycle statuses
- [x] Review feedback V1: add SQLite schema and store methods for review feedback upsert/list/status transitions
- [x] Review feedback V1: add store persistence and dedupe tests across reopen
- [x] Review feedback policy: add git_pr.review_feedback config defaults and validation (review comments only, empty ignore_authors, auto cap)
- [x] Orchestrator: implement gh api sync primitive for PR review comments into queued feedback records
- [ ] Orchestrator: implement queued feedback dispatch via Iterate flow and lifecycle handling for queued->addressed
- [ ] CLI: add metawsm review sync command with dry-run previews
- [ ] Status/watch/operator: surface review feedback counts and add review_feedback_ready intent with per-interval cap
- [ ] Validation: add fake-gh orchestrator tests for sync/dispatch and operator decision coverage
- [ ] Docs: update playbook/README and diary for review-feedback loop workflow
